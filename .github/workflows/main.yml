name: Node.js CI
on:
  push:
    branches: [ master ]
jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [12.x, 14.x, 16.15.0]
        # See supported Node.js release schedule at https://nodejs.org/en/about/releases/
    steps:
        - uses: actions/checkout@v2
        - name: Use Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@v2
          with:
            node-version: ${{ matrix.node-version }}
            cache: 'npm'
        - run: npm ci
        - run: npm run build --if-present
        - run: npm test
        - run: npm run test:e2e
        - run: npm run lint
        - uses: ravsamhq/notify-slack-action@v1
          if: always()
          with:
            status: ${{ job.status }}
            token: ${{ secrets.GITHUB_TOKEN }}
            notification_title: '{workflow} has {status_message}'
            message_format: '{emoji} *{workflow}* {status_message} in <{repo_url}|{repo}>'
            footer: 'Linked Repo <{repo_url}|{repo}> | <{workflow_url}|View Workflow>'
            notify_when: 'failure'
          env:
            SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
  sonarcloud:
    needs: build
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        # Disabling shallow clone is recommended for improving relevancy of reporting
        fetch-depth: 0
    - name: SonarCloud Scan
      uses: sonarsource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    - uses: ravsamhq/notify-slack-action@v1
      if: always()
      with:
        status: ${{ job.status }}
        token: ${{ secrets.GITHUB_TOKEN }}
        notification_title: '{workflow} has {status_message}'
        message_format: '{emoji} *{workflow}* {status_message} in <{repo_url}|{repo}>'
        footer: 'Linked Repo <{repo_url}|{repo}> | <{workflow_url}|View Workflow>'
        notify_when: 'failure'
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
  deploy: 
        needs: sonarcloud
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v2
          - uses: akhileshns/heroku-deploy@v3.12.12
            with:
              heroku_api_key: ${{secrets.HEROKU_API_KEY}}
              heroku_app_name: ${{secrets.HEROKU_APP_NAME}}
              heroku_email: ${{secrets.HEROKU_EMAIL}}
              branch: master
          - uses: ravsamhq/notify-slack-action@v1
            if: always()
            with:
              status: ${{ job.status }}
              token: ${{ secrets.GITHUB_TOKEN }}
              notification_title: '{workflow} has {status_message}'
              message_format: '{emoji} *{workflow}* {status_message} in <{repo_url}|{repo}>'
              footer: 'Linked Repo <{repo_url}|{repo}> | <{workflow_url}|View Workflow>'
              notify_when: 'failure'
            env:
              SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}
  bump-version:
    needs: deploy
    name: 'Bump Version on master'
    runs-on: ubuntu-latest
    steps:
      - name: 'Checkout source code'
        uses: 'actions/checkout@v2'
        with:
          ref: ${{ github.ref }}
      - name: 'cat package.json'
        run: cat ./package.json
      - name: 'Automated Version Bump'
        id: version-bump
        uses: 'phips28/gh-action-bump-version@master'
        with:
          minor-wording:  'add,Adds,new,added'
          major-wording:  'MAJOR,cut-major'
          patch-wording:  'patch,fixes,fixed,patched'
          rc-wording:     'RELEASE,alpha'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: 'cat package.json'
        run: cat ./package.json
      - name: 'Output Step'
        env:
          NEW_TAG: ${{ steps.version-bump.outputs.newTag }}
        run: echo "new tag $NEW_TAG"


